# 陪伴型智能机器狗系统 - 意识流架构说明

## 一、架构概述

本系统采用**意识流架构**，实现陪伴型智能机器狗的核心功能。系统不是传统的"回答问题"系统，而是建立**持续、可信、逐步演化的陪伴关系**。

## 二、核心设计原则

1. **主观优先，客观校验** - 机器狗先"回忆"，再由系统进行事实支撑
2. **记忆是被反复想起的痕迹，而非存档** - 不被想起的记忆等同于不存在
3. **宁愿记少，不要记错** - 无事实支撑的回忆会自然衰减
4. **允许遗忘，但要意识到遗忘** - 机器狗可以承认"我记不太清了"
5. **情绪是信号，不是数据** - 情绪不落库、不累计、不反向影响记忆

## 三、意识流处理流程

一次完整的回复包含以下5个步骤：

### Step 0: 用户输入
- 输入内容：当前用户消息 + 极短的会话上下文（1-2轮）
- **禁止**在此阶段引入历史记忆

### Step 1: Emotion Grounding（情绪感受）
- **使用模型**：是
- **是否查 Viking**：否
- **是否落库**：否
- **作用**：让机器狗在"当下"形成一种情绪立场，而不是基于历史关系做判断
- **输出**：情绪倾向、能量状态、行为姿态（仅存在于本次请求生命周期）

### Step 2: Subjective Recall（主观回忆）
- **使用模型**：是
- **是否查 Viking**：否
- **是否落库**：否
- **作用**：让机器狗"讲述它以为自己记得什么"
- **输出**：模糊回忆片段、长期印象、回忆置信度
- **规则**：回忆允许不准确，但不允许编造细节

### Step 3: Memory Verification（Viking 校验）
- **使用模型**：否
- **是否查 Viking**：是
- **是否落库**：否
- **作用**：为主观回忆提供事实支撑或轻微修正
- **查询库**：
  - conversation 库（事实来源）
  - dog 库（关系记忆）
  - user 库（跨狗稳定事实）
- **规则**：系统不得直接否定回忆，只允许补充、模糊修正。若查不到支撑，该回忆被标记为"衰减态"

### Step 4: Response Synthesis（回复生成）
- **使用模型**：是
- **是否查 Viking**：否
- **是否落库**：否
- **作用**：生成自然、带有边界感的回复
- **允许**：承认模糊、承认遗忘、请求补充

### Step 5: Memory Consolidation（记忆沉淀）
- **使用模型**：可选（用于总结）
- **是否查 Viking**：否
- **是否落库**：是
- **写入位置**：dog 记忆库（以 user 为 key）
- **写入内容**：
  - 稳定态度变化
  - 明确的长期偏好
  - 被多次想起并验证的互动痕迹
- **不写入的内容**：
  - 单次情绪
  - 模糊回忆
  - 未经验证的判断

## 四、记忆库职责

### 1. user 记忆库
- **职责**：存储跨狗稳定事实
- **不存**：主观评价
- **使用场景**：在 Step 3（Viking 校验）中查询，为主观回忆提供事实支撑

### 2. dog 记忆库
- **职责**：唯一承载关系变化
- **仅存**："被验证过的痕迹"
- **使用场景**：
  - 在 Step 3（Viking 校验）中查询关系记忆
  - 在 Step 5（记忆沉淀）中写入验证过的记忆

### 3. conversation 记忆库
- **职责**：作为事实来源
- **仅用于**：回忆校验（Step 3）
- **写入时机**：每轮对话结束后，作为事实记录写入

### 4. relationship 记忆库
- **职责**：不参与实时决策
- **用途**：可用于离线分析或可视化
- **注意**：在新的意识流架构中，relationship 库不再参与实时决策流程

## 五、代码结构

### 核心模块

1. **consciousness_flow.py** - 意识流处理模块
   - `ConsciousnessFlow` 类：实现完整的5步意识流处理

2. **ai_utils.py** - AI工具模块
   - `emotion_grounding()` - Step 1: 情绪感受
   - `subjective_recall()` - Step 2: 主观回忆
   - `response_synthesis()` - Step 4: 回复生成
   - `memory_consolidation()` - Step 5: 记忆沉淀

3. **memory_writing.py** - 记忆写入模块
   - `consolidate_memory_to_dog()` - 将验证过的记忆沉淀到dog库

4. **memory_utils.py** - 记忆工具模块
   - `search_viking_memories()` - 搜索Viking记忆库（用于Step 3）

5. **routes.py** - API路由模块
   - `/api/debug/chat` - 使用意识流架构的聊天接口

## 六、API使用示例

### 调试聊天接口

```python
POST /api/debug/chat

请求体：
{
    "query": "用户输入",
    "user_id": "user_001",
    "dog_id": "dog_001",
    "conversation_id": "conv_001",
    "model": "chatgpt"  // 可选，默认chatgpt
}

响应：流式SSE格式
```

### 处理流程

1. 接收用户输入
2. 执行意识流5步处理
3. 流式返回回复
4. 自动进行记忆沉淀（如果需要）
5. 写入conversation库作为事实来源

## 七、关键设计决策

### 为什么不采用其他设计方案？

1. **为什么不用关系库作为核心？**
   - 关系是过程，不是结论
   - 结构化关系会写死陪伴体验

2. **为什么不用直接 RAG？**
   - 检索优先会压扁主观性
   - 陪伴感下降

3. **为什么不存情绪？**
   - 情绪累计会污染人格
   - 情绪不是长期属性

## 八、系统价值

该架构实现了：
- ✅ 可解释、可调试的意识流
- ✅ 不依赖虚构维持亲密
- ✅ 支持慢关系、长期陪伴
- ✅ 工程复杂度可控

这是一个**可以落地、可以扩展、可以被他人理解与复用的陪伴型智能生命架构**。
